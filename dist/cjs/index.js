"use strict";let e=0;const t=e=>"init"in e,n=e=>!!e.write,o=new WeakMap,r=(e,t)=>{const n=o.get(e);n&&(o.delete(e),n(t))},s=(e,t)=>{e.status="fulfilled",e.value=t},i=(e,t)=>{e.status="rejected",e.reason=t},a=(e,t)=>"v"in e&&"v"in t&&Object.is(e.v,t.v),l=(e,t)=>"e"in e&&"e"in t&&Object.is(e.e,t.e),c=e=>"v"in e&&e.v instanceof Promise,u=e=>{if("e"in e)throw e.e;return e.v},d=()=>{const e=new WeakMap,d=new WeakMap,f=new Map;let v,h;v=new Set,h=new Set;const g=t=>e.get(t),w=(t,n)=>{Object.freeze(n);const o=e.get(t);if(e.set(t,n),f.has(t)||f.set(t,o),o&&c(o)){const e="v"in n?n.v instanceof Promise?n.v:Promise.resolve(n.v):Promise.reject(n.e);r(o.v,e)}},_=(e,t,n)=>{const o=new Map;let r=!1;n.forEach(((n,s)=>{n||s!==e||(n=t),n?(o.set(s,n),t.d.get(s)!==n&&(r=!0)):console.warn("[Bug] atom state not found")})),(r||t.d.size!==o.size)&&(t.d=o)},p=(e,t,n)=>{const o=g(e),r={d:(null==o?void 0:o.d)||new Map,v:t};if(n&&_(e,r,n),o&&a(o,r)&&o.d===r.d)return o;if(o&&c(o)&&c(r)&&(i=r,"v"in(s=o)&&"v"in i&&s.v.orig&&s.v.orig===i.v.orig)){if(o.d===r.d)return o;r.v=o.v}var s,i;return w(e,r),r},E=(e,t,n,r)=>{if("function"==typeof(null==(a=t)?void 0:a.then)){let a;const l=new Promise(((o,r)=>{let c=!1;t.then((t=>{if(!c){c=!0;const r=g(e),i=p(e,l,n);s(l,t),o(t),d.has(e)&&(null==r?void 0:r.d)!==i.d&&O(e,i,null==r?void 0:r.d)}}),(t=>{if(!c){c=!0;const o=g(e),s=p(e,l,n);i(l,t),r(t),d.has(e)&&(null==o?void 0:o.d)!==s.d&&O(e,s,null==o?void 0:o.d)}})),a=e=>{c||(c=!0,e.then((e=>s(l,e)),(e=>i(l,e))),o(e))}}));return l.orig=t,l.status="pending",((e,t)=>{o.set(e,t),e.catch((()=>{})).finally((()=>o.delete(e)))})(l,(e=>{e&&a(e),null==r||r()})),p(e,l,n)}var a;return p(e,t,n)},m=(e,o)=>{const r=g(e);if(!o&&r){if(d.has(e))return r;if(Array.from(r.d).every((([t,n])=>t===e||m(t)===n)))return r}const s=new Map;let i=!0;const a=n=>{if(n===e){const e=g(n);if(e)return s.set(n,e),u(e);if(t(n))return s.set(n,void 0),n.init;throw new Error("no atom init")}const o=m(n);return s.set(n,o),u(o)};let c,f;const v={get signal(){return c||(c=new AbortController),c.signal},get setSelf(){return n(e)||console.warn("setSelf function cannot be used with read-only atom"),!f&&n(e)&&(f=(...t)=>{if(i&&console.warn("setSelf function cannot be called in sync"),!i)return A(e,...t)}),f}};try{const t=e.read(a,v);return E(e,t,s,(()=>null==c?void 0:c.abort()))}catch(t){return((e,t,n)=>{const o=g(e),r={d:(null==o?void 0:o.d)||new Map,e:t};return n&&_(e,r,n),o&&l(o,r)&&o.d===r.d?o:(w(e,r),r)})(e,t,s)}finally{i=!1}},y=e=>u(m(e)),b=(e,t)=>!t.l.size&&(!t.t.size||1===t.t.size&&t.t.has(e)),S=e=>{const t=new Map,n=new WeakMap,o=e=>{var t;const n=new Set(null==(t=d.get(e))?void 0:t.t);return f.forEach(((t,o)=>{var r;(null==(r=g(o))?void 0:r.d.has(e))&&n.add(o)})),n},r=e=>{o(e).forEach((o=>{o!==e&&(t.set(o,(t.get(o)||new Set).add(e)),n.set(o,(n.get(o)||0)+1),r(o))}))};r(e);const s=e=>{o(e).forEach((o=>{var r;if(o!==e){let e=n.get(o);if(e&&n.set(o,--e),!e){let e=!!(null==(r=t.get(o))?void 0:r.size);if(e){const t=g(o),n=m(o,!0);e=!t||!a(t,n)}e||t.forEach((e=>e.delete(o)))}s(o)}}))};s(e)},M=(e,...n)=>{let o=!0;const r=e.write((e=>u(m(e))),((n,...r)=>{let s;if(n===e){if(!t(n))throw new Error("atom not writable");const e=g(n),o=E(n,r[0]);e&&a(e,o)||S(n)}else s=M(n,...r);if(!o){const e=I();v.forEach((t=>t({type:"async-write",flushed:e})))}return s}),...n);return o=!1,r},A=(e,...t)=>{const n=M(e,...t),o=I();return v.forEach((e=>e({type:"write",flushed:o}))),n},T=(e,t,o)=>{var r;const s=o||[];null==(r=g(e))||r.d.forEach(((t,n)=>{const o=d.get(n);o?o.t.add(e):n!==e&&T(n,e,s)})),m(e);const i={t:new Set(t&&[t]),l:new Set};if(d.set(e,i),h.add(e),n(e)&&e.onMount){const{onMount:t}=e;s.push((()=>{const n=t(((...t)=>A(e,...t)));n&&(i.u=n)}))}return o||s.forEach((e=>e())),i},N=e=>{var t;const n=null==(t=d.get(e))?void 0:t.u;n&&n(),d.delete(e),h.delete(e);const o=g(e);o?(c(o)&&r(o.v),o.d.forEach(((t,n)=>{if(n!==e){const t=d.get(n);t&&(t.t.delete(e),b(n,t)&&N(n))}}))):console.warn("[Bug] could not find atom state to unmount",e)},O=(e,t,n)=>{const o=new Set(t.d.keys());null==n||n.forEach(((t,n)=>{if(o.has(n))return void o.delete(n);const r=d.get(n);r&&(r.t.delete(e),b(n,r)&&N(n))})),o.forEach((t=>{const n=d.get(t);n?n.t.add(e):d.has(e)&&T(t,e)}))},I=()=>{let e;for(e=new Set;f.size;){const t=Array.from(f);f.clear(),t.forEach((([t,n])=>{const o=g(t);if(o){const r=d.get(t);r&&o.d!==(null==n?void 0:n.d)&&O(t,o,null==n?void 0:n.d),!r||n&&!c(n)&&(a(n,o)||l(n,o))||(r.l.forEach((e=>e())),e.add(t))}else console.warn("[Bug] no atom state to flush")}))}return e},z=(e,t)=>{const n=(e=>{let t=d.get(e);return t||(t=T(e)),t})(e),o=I(),r=n.l;return r.add(t),v.forEach((e=>e({type:"sub",flushed:o}))),()=>{r.delete(t),(e=>{const t=d.get(e);t&&b(e,t)&&N(e)})(e),v.forEach((e=>e({type:"unsub"})))}};return{get:y,set:A,sub:z,dev_subscribe_store:(e,t)=>{if(2!==t)throw new Error("The current StoreListener revision is 2.");return v.add(e),()=>{v.delete(e)}},dev_get_mounted_atoms:()=>h.values(),dev_get_atom_state:t=>e.get(t),dev_get_mounted:e=>d.get(e),dev_restore_atoms:e=>{for(const[n,o]of e)t(n)&&(E(n,o),S(n));const n=I();v.forEach((e=>e({type:"restore",flushed:n})))}}};let f;"number"==typeof globalThis.__NUMBER_OF_JOTAI_INSTANCES__?++globalThis.__NUMBER_OF_JOTAI_INSTANCES__:globalThis.__NUMBER_OF_JOTAI_INSTANCES__=1;const v=()=>(f||(1!==globalThis.__NUMBER_OF_JOTAI_INSTANCES__&&console.warn("Detected multiple Jotai instances. It may cause unexpected behavior with the default store. https://github.com/pmndrs/jotai/discussions/2044"),f=d()),f);function h(e){var t;return null!==(t=null==e?void 0:e.store)&&void 0!==t?t:v()}exports.atom=function(t,n){const o="atom"+ ++e,r={toString:()=>o};return"function"==typeof t?r.read=t:(r.init=t,r.read=e=>e(r),r.write=(e,t,n)=>t(r,"function"==typeof n?n(e(r)):n)),n&&(r.write=n),r},exports.createStore=d,exports.useAtom=function(e,t){var n=h(t);return{subscribe:function(t){return t(n.get(e)),n.sub(e,(function(){var o=n.get(e);t(o)}))},update:function(){for(var t=[],o=0;o<arguments.length;o++)t[o]=arguments[o];if((void 0).DEV&&!("write"in e))throw new Error("not writable atom");return n.set.apply(n,function(e,t,n){if(n||2===arguments.length)for(var o,r=0,s=t.length;r<s;r++)!o&&r in t||(o||(o=Array.prototype.slice.call(t,0,r)),o[r]=t[r]);return e.concat(o||Array.prototype.slice.call(t))}([e],t,!1))}}},exports.useStore=h;
//# sourceMappingURL=index.js.map
